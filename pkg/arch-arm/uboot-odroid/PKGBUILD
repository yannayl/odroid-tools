# Overview
# ========
#
#   Package:    U-Boot for ODROID-X/X2/U2/U3
#   Maintainer: Zoltan Tombol <zoltan dot tombol at gmail>
#
#   Based on:
#     - alarm/uboot-odroid (Arch Linux ARM)
#         Maintainer: Kevin Mihelich <kevin@archlinuxarm.org>
#

buildarch=4

pkgbase=uboot-odroid
pkgname=('uboot-odroid' 'uboot-odroid-x')
pkgver=2016.11
pkgrel=1
arch=('armv7h')
url='http://www.denx.de/wiki/U-Boot/WebHome'
license=('GPL')
install="${pkgbase}.install"
backup=('boot/extlinux/extlinux.conf')
makedepends=('bc' 'dtc')
_commit=dd9a970aa4accf5d266d334c0f319c674e933027
source=("ftp://ftp.denx.de/pub/u-boot/u-boot-${pkgver}.tar.bz2"
        "https://github.com/hardkernel/u-boot/raw/${_commit}/sd_fuse/bl1.HardKernel"
        "https://github.com/hardkernel/u-boot/raw/${_commit}/sd_fuse/bl2.HardKernel"
        "https://github.com/hardkernel/u-boot/raw/${_commit}/sd_fuse/tzsw.HardKernel"
        'sd_fusing.sh'
        '0001-generic-distro-config-support.patch'
        '0002-odroid-x-support.patch'
        'extlinux.conf')
sha512sums=('d393b2aa4114a6de7f990efe370891376c934a1cfac9530c3bc44f988e7f2c9f0ec26653e3275c72a0a1c2f4b44fcd0afe8394c9ae3ca93fee1c689d870c063d'
            '04bd91f8c46f72d0f6d09b4cec70e9617e82cccee5e6b660e2ec54aa64972169f48b7c81ee2a9f31fa513bf99021de443bebc871a25569eaaf25aaf4da208e8d'
            'e40cfd4ee603ab954dc1db213fe8f2cfc387a2e3224cfab71bade4cbdf64d89558d5300c113e877c173e7561dcc716f098cf976c5b5a725b9d8462543d802e03'
            '6730b711150f74f6861868d8df31913588018bafe3098f4e51e0226ef53264aa7c73ade19d21b173beb9725aca79422521077df725982a651bcc4e3c9671ef04'
            '2428c31fab908e19b8462db3bc516ec43dad61f8a91b8e04b6d3e1ddba42e4ec5732f85c1a32cbd8d49b5b086858064eba11135c43272195c0f64e04f8d79805'
            '9afaace10a3e491a8494d4dae1b4dd78b1efa416c1dd005621f469a281293dd7b9450458561e1b04c357ab54f2fcdfba650763ce685a7af11f9045904cb95b24'
            '135dcf4e2ff71234540257e25c7e229ba983f98a585ff5eb6524603bc65f9d4ee4ba382189edd229a1d2728a9520e09f56a05b5755dff8bde7bb49bd25e474f7'
            'd62530d051ccef62679ca29b351113b095f5e5728cd320d44cb729a4fb03f73d798c7428a4aef532a0f67a5f5cb9ce649b078776cd238b4709ac16e9ef5a3480')

prepare() {
  cd "u-boot-${pkgver}"

  patch -p1 -i "${srcdir}/0001-generic-distro-config-support.patch"
}

build() {
  cd "u-boot-${pkgver}"

  unset CFLAGS
  unset CXXFLAGS
  unset CPPFLAGS

  # Build for X2/U2/U3.
  make distclean 
  make odroid_config
  make EXTRAVERSION="-${pkgrel}"
  mv u-boot-dtb.bin "${srcdir}/u-boot-dtb.bin"

  # Patch and build for X.
  patch -p1 -i "${srcdir}/0002-odroid-x-support.patch"
  make distclean
  make odroid_config
  make EXTRAVERSION="-${pkgrel}"
}

package_uboot-odroid() {
  pkgdesc='U-Boot for ODROID-X2/U2/U3'

  cd "${srcdir}"

  mkdir -p "${pkgdir}/boot"
  cp u-boot-dtb.bin "${pkgdir}/boot/u-boot.bin"
  cp {{bl1,bl2,tzsw}.HardKernel,sd_fusing.sh} "${pkgdir}/boot"

  mkdir -p "${pkgdir}/boot/extlinux"
  cp extlinux.conf "${pkgdir}/boot/extlinux"
}

package_uboot-odroid-x() {
  pkgdesc='U-Boot for ODROID-X'

  cd "${srcdir}"

  mkdir -p "${pkgdir}/boot"
  cp "u-boot-${pkgver}/u-boot-dtb.bin" "${pkgdir}/boot/u-boot.bin"
  cp {{bl1,bl2,tzsw}.HardKernel,sd_fusing.sh} "${pkgdir}/boot"

  mkdir -p "${pkgdir}/boot/extlinux"
  cp extlinux.conf "${pkgdir}/boot/extlinux"
}
